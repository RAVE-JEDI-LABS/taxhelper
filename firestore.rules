rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    // Check if request is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Get the user document for the authenticated user
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Get user role from users collection
    function getUserRole() {
      return getUserData().role;
    }

    // Role-based checks
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }

    function isPreparer() {
      return isAuthenticated() && getUserRole() in ['admin', 'preparer'];
    }

    function isStaff() {
      return isAuthenticated() && getUserRole() in ['admin', 'preparer', 'front_desk'];
    }

    function isCustomer() {
      return isAuthenticated() && getUserRole() == 'customer';
    }

    // Check if the authenticated customer owns a customer record
    // Customers have their Firebase UID stored in their customer record's firebaseUid field
    function ownsCustomerRecord(customerId) {
      return get(/databases/$(database)/documents/customers/$(customerId)).data.firebaseUid == request.auth.uid;
    }

    // Check if customer owns a resource that has a customerId field
    function ownsResourceByCustomerId(resourceData) {
      return isAuthenticated() &&
             resourceData.customerId != null &&
             ownsCustomerRecord(resourceData.customerId);
    }

    // ============================================
    // USERS COLLECTION
    // Staff can read all users, users can read/update own profile
    // Only admin can change roles
    // ============================================
    match /users/{userId} {
      // Anyone can read own profile, staff can read all
      allow read: if isAuthenticated() &&
                    (request.auth.uid == userId || isStaff());

      // Users can create their own profile on first login
      allow create: if isAuthenticated() &&
                      request.auth.uid == userId &&
                      request.resource.data.role in ['customer'];

      // Users can update own profile, admin can update anyone
      // But only admin can change role field
      allow update: if isAuthenticated() && (
        // Admin can update anything
        isAdmin() ||
        // User can update own profile but not role/permissions
        (request.auth.uid == userId &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'permissions']))
      );

      // Only admin can delete users
      allow delete: if isAdmin();
    }

    // ============================================
    // CUSTOMERS COLLECTION
    // Staff can CRUD, customers can read own record only
    // ============================================
    match /customers/{customerId} {
      // Staff can read all, customers can read own
      allow read: if isStaff() ||
                    (isCustomer() && ownsCustomerRecord(customerId));

      // Only staff can create customers
      allow create: if isStaff();

      // Staff can update any customer
      // Customers can update own record but NOT sensitive fields
      allow update: if isStaff() ||
                      (isCustomer() && ownsCustomerRecord(customerId) &&
                       !request.resource.data.diff(resource.data).affectedKeys()
                         .hasAny(['assignedPreparer', 'ssnEncrypted', 'bankingInfo', 'firebaseUid', 'portalAccess']));

      // Only admin can delete customers
      allow delete: if isAdmin();
    }

    // ============================================
    // TAX RETURNS COLLECTION
    // Staff can CRUD, customers can read own returns only
    // ============================================
    match /returns/{returnId} {
      // Staff can read all, customers can read own
      allow read: if isStaff() ||
                    (isCustomer() && ownsResourceByCustomerId(resource.data));

      // Only preparers can create/update returns
      allow create: if isPreparer();
      allow update: if isPreparer();

      // Only admin can delete returns
      allow delete: if isAdmin();
    }

    // ============================================
    // DOCUMENTS COLLECTION
    // Staff can CRUD, customers can read own and upload to own
    // ============================================
    match /documents/{documentId} {
      // Staff can read all, customers can read own
      allow read: if isStaff() ||
                    (isCustomer() && ownsResourceByCustomerId(resource.data));

      // Staff can create documents for any customer
      // Customers can create documents for themselves only
      allow create: if isStaff() ||
                      (isCustomer() && ownsCustomerRecord(request.resource.data.customerId));

      // Only preparers can update documents (OCR results, status, etc.)
      allow update: if isPreparer();

      // Only admin can delete documents
      allow delete: if isAdmin();
    }

    // ============================================
    // APPOINTMENTS COLLECTION
    // Staff can CRUD, customers can read own and create appointments
    // ============================================
    match /appointments/{appointmentId} {
      // Staff can read all, customers can read own
      allow read: if isStaff() ||
                    (isCustomer() && ownsResourceByCustomerId(resource.data));

      // Staff can create for anyone, customers can create for themselves
      allow create: if isStaff() ||
                      (isCustomer() && ownsCustomerRecord(request.resource.data.customerId));

      // Only staff can update appointments
      allow update: if isStaff();

      // Only admin can delete appointments
      allow delete: if isAdmin();
    }

    // ============================================
    // COMMUNICATIONS COLLECTION
    // Staff only - customers should not see internal communications
    // ============================================
    match /communications/{communicationId} {
      allow read, write: if isStaff();
    }

    // ============================================
    // CALL LOGS COLLECTION
    // Staff only - phone call records
    // ============================================
    match /call_logs/{logId} {
      allow read, write: if isStaff();
    }

    // ============================================
    // SMS LOGS COLLECTION
    // Staff only - SMS message records
    // ============================================
    match /sms_logs/{logId} {
      allow read, write: if isStaff();
    }

    // ============================================
    // CHAT LOGS COLLECTION
    // Staff can read all, customers can read own sessions
    // ============================================
    match /chat_logs/{logId} {
      // Staff can read all, check customerId for customer access
      allow read: if isStaff() ||
                    (isAuthenticated() && resource.data.customerId == request.auth.uid);

      // Anyone authenticated can create (for anonymous chat before login)
      allow create: if isAuthenticated();

      // Staff can update all, customers can update own
      allow update: if isStaff() ||
                      (isAuthenticated() && resource.data.customerId == request.auth.uid);
    }

    // ============================================
    // KANBAN FEATURES COLLECTION
    // Staff only - internal workflow management
    // ============================================
    match /kanban_features/{featureId} {
      allow read, write: if isStaff();
    }

    // ============================================
    // CONTACT SUBMISSIONS COLLECTION
    // Anyone can submit, staff can read/update
    // ============================================
    match /contact_submissions/{submissionId} {
      // Anyone can create a submission (public form)
      allow create: if true;

      // Only staff can read and update submissions
      allow read, update: if isStaff();

      // Only admin can delete
      allow delete: if isAdmin();
    }

    // ============================================
    // WORKFLOWS COLLECTION
    // Staff only - internal workflow definitions
    // ============================================
    match /workflows/{workflowId} {
      allow read: if isStaff();
      allow write: if isAdmin();
    }

    // ============================================
    // DEFAULT DENY
    // Explicitly deny access to any other collections
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
